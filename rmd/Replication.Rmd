---
title: "Replication"
author: "Shunsuke Matsuno"
date: "2020/6/1"
output:
  html_document:
    code_folding: show
    df_print: paged
    number_sections: no
    theme: united
    toc: yes
    toc_float: no
  pdf_document:
    toc: yes
---

```{r settings, echo=FALSE}
### Setting the global code chunk options ###
# Args
#   comment='': won't append any string to the start of each line of results
#   fig.align='center': align figures to the center of document
knitr::opts_chunk$set(comment="", fig.align="center", warning = FALSE)
```
# Required libraries
```{r}
easypackages::libraries('tidyverse', 'ggplot2','NumbersGame')
```


# Introduction
- This note replicates Bird, Karolyi, and Ruchti (BKR; 2019, JAE).

# Simulating the data
- Since I don't have access to the original data, I simulate the "observed" data using the estimated parameters in BKR.

## Parameters
- $\theta = (\eta, \gamma, \psi^2, \zeta)$
```{r}
set.seed(1)

# Table 4
eta <- 0.0161   # marginal cost
gamma <- 2.0817    # curvature
psi2 <- 0.8201   # variance
zeta <- 3.7105    # variance multiplier
theta <- c(eta, gamma, psi2, zeta)

# Table 2
benefit <- 1.447
```

## Latent earnings distribution
- I assume that latent earnings distribution is generated by normal distribution.
```{r}
# number of firms
N <- 10000
sigma2 <- 5

df_firm <- tibble(
  firm = 1:N,
  e = rnorm(N, 0, sigma2)    # latent earnings surprize
)%>% 
  mutate(e = case_when(e <= -21 ~ -20.999, e >= 21 ~ 20.999, TRUE ~ e)) %>%     # winsorize
  mutate(bin_e = map_dbl(.x = e, .f = floor)) %>%    # bins
  mutate(bin_normalized  = bin_e + (20 + 1))    # the left-end bin is normalized (labeled) as 1
df_firm

ggplot(df_firm, aes(x = e)) +
  geom_histogram(bins = 41, color = 'white') +
  xlim(-21, 21)
```

## Manipulation
- Each firm decides the amount of manipulation, $m$, according to the maximization problem.
- `compute_utility` computes the following utility:
$$
u_{\text {Discrete}}(b, m, \theta)=\sum_{-20}^{20} \phi_{m, \theta}(\varepsilon) \mathcal{B}(b+m+\varepsilon) d \varepsilon-\beta_{b} m^{\gamma}
$$
```{r}
df_firm_utility <- compute_optimal_manipulation(df_firm, benefit, theta)
df_firm_utility
```

```{r}
# plot
plot_latent_reported(df_firm_utility)
```

- The 'empirical' distribution of earnings surprises, $R$, is a bit drastic than the actual empirical distribution.
    - Compare the folloing graph with Fig.2.
    - This is because my simulation assumes that the empirical distribution is solely determinded by the optimization behabior of BKR's model, while in reality varaety of other factors come into play.
    
```{r}
qplot(df_firm_utility$R, geom = 'bar', xlim = c(-10,10))
```

- See what happens if we increase the marginal cost parameter, $\eta$.
```{r}
theta_new <- theta
theta_new[1] <- 0.5

df_firm_utility <- compute_optimal_manipulation(df_firm, benefit, theta = theta_new)
plot_latent_reported(df_firm_utility)
```

